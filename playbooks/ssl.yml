---
- name: Manage SSL Certificates
  hosts: all
  become: true
  gather_facts: true
  
  vars_files:
    - ../vars/secrets.yml
    
  vars:
    required_vars:
      - domain
    certbot_package: "python3-certbot-nginx"
    force_renewal: false
    email: "webmaster@{{ domain }}"
    
  pre_tasks:
    - name: Verify required variables are defined
      ansible.builtin.assert:
        that: "{{ item }} is defined"
        fail_msg: "Required variable '{{ item }}' is not defined"
      loop: "{{ required_vars }}"

    - name: Check if domain exists in Nginx
      ansible.builtin.stat:
        path: "/etc/nginx/sites-available/{{ domain }}.conf"
      register: nginx_conf

    - name: Fail if domain doesn't exist in Nginx
      ansible.builtin.fail:
        msg: "Domain {{ domain }} is not configured in Nginx. Please create the virtual host first."
      when: not nginx_conf.stat.exists
      
  tasks:
    - name: Install Certbot (RedHat/CentOS)
      ansible.builtin.dnf:
        name: "{{ certbot_package }}"
        state: present
      when: ansible_os_family == "RedHat"

    - name: Install Certbot (Debian/Ubuntu)
      ansible.builtin.apt:
        name: "{{ certbot_package }}"
        state: present
      when: ansible_os_family == "Debian"

    - name: Check if certificate already exists
      ansible.builtin.stat:
        path: "/etc/letsencrypt/live/{{ domain }}/fullchain.pem"
      register: cert_file

    - name: Obtain SSL certificate
      ansible.builtin.command: >
        certbot --nginx
        --non-interactive
        --agree-tos
        --email {{ email }}
        --domains {{ domain }}
        {{ '--force-renewal' if force_renewal else '' }}
      register: certbot_result
      changed_when: "'Congratulations! Your certificate and chain have been saved' in certbot_result.stdout"
      when: not cert_file.stat.exists or force_renewal

    - name: Obtain SSL certificate for domain and subdomains
      ansible.builtin.command: >
        certbot --nginx
        --non-interactive
        --agree-tos
        --email {{ email }}
        --domains {{ domain }},{{ mail_subdomain }}
        {{ '--force-renewal' if force_renewal else '' }}
      register: certbot_result
      changed_when: "'Congratulations! Your certificate and chain have been saved' in certbot_result.stdout"
      when: (not cert_file.stat.exists or force_renewal) and domain == master_domain

    - name: Install cronjob for certificate renewal
      ansible.builtin.cron:
        name: "Certbot automatic renewal"
        job: "certbot renew --quiet --non-interactive"
        minute: "0"
        hour: "3"
        weekday: "1"  # Monday

    - name: Display certificate information
      ansible.builtin.shell: "certbot certificates -d {{ domain }}"
      register: cert_info
      changed_when: false

    - name: Output certificate information
      ansible.builtin.debug:
        msg: "{{ cert_info.stdout_lines }}"

    - name: Update Nginx virtual host with SSL enabled
      ansible.builtin.template:
        src: ../templates/nginx/vhost.conf.j2
        dest: "/etc/nginx/sites-available/{{ domain }}.conf"
        owner: root
        group: root
        mode: '0644'
      vars:
        nginx_ssl_enabled: true
      notify: Restart Nginx

    - name: Update Nginx configuration with SSL optimizations
      ansible.builtin.blockinfile:
        path: "/etc/nginx/sites-available/{{ domain }}.conf"
        marker: "# {mark} ANSIBLE MANAGED SSL OPTIMIZATION BLOCK"
        block: |
          # SSL optimization
          ssl_session_timeout 1d;
          ssl_session_cache shared:SSL:10m;
          ssl_session_tickets off;

          # Modern TLS configuration
          ssl_protocols TLSv1.2 TLSv1.3;
          ssl_prefer_server_ciphers off;

          # HSTS (uncomment to enable)
          # add_header Strict-Transport-Security "max-age=63072000" always;
      notify: Restart Nginx
      
  handlers:
    - name: Restart Nginx
      ansible.builtin.service:
        name: nginx
        state: restarted