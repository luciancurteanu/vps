name: Molecule CI

on:
  push:
    paths:
      - 'roles/**'
      - 'playbooks/**'
  pull_request:
    paths:
      - 'roles/**'
      - 'playbooks/**'
  workflow_dispatch: {}

jobs:
  molecule-test:
    runs-on: [self-hosted, almalinux]
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Make scripts executable
        run: |
          sudo chmod +x scripts/*.sh || true
          sudo chmod +x scripts/**/*.sh || true

      - name: Run CI setup (install Docker, Python venv, Molecule deps)
        run: sudo bash scripts/ci-setup.sh --yes

      - name: Run smoke Molecule test for 'common' role
        run: |
          source ~/molecule-env/bin/activate
          bash scripts/run-test.sh common || (cat roles/common/molecule/default/molecule.log || true; false)
