---
# OpenDKIM configuration tasks

- name: Install OpenDKIM packages
  ansible.builtin.package:
    name:
      - opendkim
      - opendkim-tools
    state: present

- name: Create OpenDKIM directories
  ansible.builtin.file:
    path: "{{ item }}"
    state: directory
    owner: opendkim
    group: opendkim
    mode: '0755'
  with_items:
    - /etc/opendkim
    - /etc/opendkim/keys
    - /etc/opendkim/keys/{{ domain }}

- name: Configure OpenDKIM main configuration
  ansible.builtin.template:
    src: opendkim/opendkim.conf.j2
    dest: /etc/opendkim.conf
    owner: root
    group: root
    mode: '0644'
  notify: restart opendkim

- name: Configure OpenDKIM key table
  ansible.builtin.template:
    src: opendkim/KeyTable.j2
    dest: /etc/opendkim/KeyTable
    owner: root
    group: root
    mode: '0644'
  notify: restart opendkim

- name: Configure OpenDKIM signing table
  ansible.builtin.template:
    src: opendkim/SigningTable.j2
    dest: /etc/opendkim/SigningTable
    owner: root
    group: root
    mode: '0644'
  notify: restart opendkim

- name: Configure OpenDKIM trusted hosts
  ansible.builtin.template:
    src: opendkim/TrustedHosts.j2
    dest: /etc/opendkim/TrustedHosts
    owner: root
    group: root
    mode: '0644'
  notify: restart opendkim

- name: Check if DKIM keys already exist
  ansible.builtin.stat:
    path: /etc/opendkim/keys/{{ domain }}/mail.private
  register: dkim_key
  when: domain is defined

- name: Generate DKIM keys
  ansible.builtin.shell: opendkim-genkey -D /etc/opendkim/keys/{{ domain }}/ -d {{ domain }} -s mail
  args:
    creates: /etc/opendkim/keys/{{ domain }}/mail.private
  when: domain is defined and not dkim_key.stat.exists

- name: Set proper ownership for DKIM keys
  ansible.builtin.file:
    path: "{{ item }}"
    owner: opendkim
    group: opendkim
    mode: '0640'
  with_items:
    - /etc/opendkim/keys/{{ domain }}/mail.private
    - /etc/opendkim/keys/{{ domain }}/mail.txt
  when: domain is defined

- name: Display DKIM DNS record information
  ansible.builtin.shell: cat /etc/opendkim/keys/{{ domain }}/mail.txt
  register: dkim_txt
  changed_when: false
  when: domain is defined

- name: Print DKIM DNS record
  ansible.builtin.debug:
    msg: "Add this TXT record to your DNS: {{ dkim_txt.stdout }}"
  when: domain is defined and dkim_txt is defined

- name: Ensure OpenDKIM service is running and enabled
  ansible.builtin.service:
    name: opendkim
    state: started
    enabled: true