---
# Verify php-fpm installation and service status

- name: Check php-fpm unit file exists
  ansible.builtin.stat:
    path: /usr/lib/systemd/system/php-fpm.service
  register: php_fpm_unit_stat
  when: ansible_os_family == "RedHat"

- name: Fail if php-fpm unit file is missing
  ansible.builtin.fail:
    msg: "php-fpm.service unit file not found"
  when: ansible_os_family == 'RedHat' and not php_fpm_unit_stat.stat.exists

- name: Reload systemd daemon
  ansible.builtin.systemd:
    daemon_reload: true
  when: ansible_service_mgr == 'systemd'

- name: Gather service facts
  ansible.builtin.service_facts:
  when: ansible_service_mgr == 'systemd'

- name: Ensure php-fpm service is running
  ansible.builtin.service:
    name: Php-fpm.service
    state: started
  when: ansible_service_mgr == 'systemd' and ansible_facts.services['php-fpm.service'].state != 'running'

- name: Ensure php-fpm is enabled
  ansible.builtin.systemd:
    name: Php-fpm.service
    enabled: true
  when: ansible_service_mgr == 'systemd'
