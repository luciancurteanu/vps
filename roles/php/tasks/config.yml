---
# Configure PHP-FPM and apply necessary permissions

- name: Backup original www.conf (RedHat)
  ansible.builtin.copy:
    src: /etc/php-fpm.d/www.conf
    mode: '0644'
    dest: /etc/php-fpm.d/www.conf.bak
    remote_src: true
    force: false
  when: ansible_os_family == "RedHat"

- name: Check for package-installed nginx php-fpm include
  ansible.builtin.stat:
    path: /etc/nginx/conf.d/php-fpm.conf
  register: nginx_php_conf

- name: Backup nginx php-fpm include into /etc/php-fpm.d (if present)
  ansible.builtin.copy:
    src: /etc/nginx/conf.d/php-fpm.conf
    dest: /etc/php-fpm.d/php-fpm.conf.nginx.bak
    remote_src: true
    force: false
  when: nginx_php_conf.stat.exists

- name: Remove package-installed nginx php-fpm include
  ansible.builtin.file:
    path: /etc/nginx/conf.d/php-fpm.conf
    state: absent
  when: nginx_php_conf.stat.exists
  notify: Restart Nginx

- name: Configure PHP-FPM pool settings
  ansible.builtin.lineinfile:
    path: /etc/php-fpm.d/www.conf
    regexp: "{{ item.regexp }}"
    line: "{{ item.line }}"
  loop:
    - { regexp: '^listen =',       line: 'listen = {{ php_fpm_listen }}' }
    - { regexp: '^user =',         line: 'user = {{ nginx_user }}' }
    - { regexp: '^group =',        line: 'group = {{ nginx_group }}' }
    - { regexp: '^listen.owner',   line: 'listen.owner = {{ nginx_user }}' }
    - { regexp: '^listen.group',   line: 'listen.group = {{ nginx_group }}' }
    - { regexp: '^listen.mode',    line: 'listen.mode = 0660' }
    - { regexp: '^;listen.acl_users', line: ';listen.acl_users = apache, nginx' }
  notify: Restart php-fpm
  when: ansible_os_family == "RedHat"

- name: Insert OPCache settings into php.ini
  ansible.builtin.blockinfile:
    path: /etc/php.ini
    marker: "; ANSIBLE MANAGED OPCACHE BLOCK"
    block: |
      [opcache]
      opcache.enable=1
      opcache.memory_consumption=128
      opcache.interned_strings_buffer=8
      opcache.max_accelerated_files=4000
      opcache.revalidate_freq=2
      opcache.fast_shutdown=1
      opcache.enable_cli=1
  when: ansible_os_family == "RedHat"

- name: Ensure PHP-FPM run directory exists
  ansible.builtin.file:
    path: "{{ php_fpm_listen | dirname }}"
    state: directory
    owner: root
    group: root
  when: ansible_os_family == "RedHat"

- name: Deploy managed shared www pool
  ansible.builtin.template:
    src: www.conf.j2
    dest: /etc/php-fpm.d/www.conf
    owner: root
    group: root
  when: php_fpm_create_www | default(true) and ansible_os_family == 'RedHat'
  notify: Restart php-fpm

- name: Ensure PHP-FPM log directory ownership
  ansible.builtin.file:
    path: /var/log/php-fpm
    state: directory
    owner: nginx
    group: root
  when: ansible_os_family == "RedHat"

- name: Ensure /var/lib/php ownership and group (RedHat)
  ansible.builtin.file:
    path: /var/lib/php
    recurse: true
    state: directory
    mode: '0755'
    owner: root
    group: nginx
  when: ansible_os_family == "RedHat"

- name: Ensure PHP session directory permissions
  ansible.builtin.file:
    path: /var/lib/php/session
    state: directory
    owner: nginx
    group: nginx
  when: ansible_os_family == "RedHat"

- name: Enable and start php-fpm service
  ansible.builtin.systemd:
    name: php-fpm.service
    enabled: true
    state: started
  when: ansible_os_family == "RedHat"

- name: Restore SELinux context for php-fpm run directory
  ansible.builtin.command: restorecon -Rv "{{ php_fpm_listen | dirname }}"
  when: ansible_selinux.status == "enabled"
  changed_when: false

- name: Create sanitized domain system users for PHP-FPM pools
  ansible.builtin.user:
    name: "{{ item | replace('.', '_') }}"
    comment: "Domain account for {{ item }}"
    system: true
    create_home: false
    shell: /sbin/nologin
  loop: "{{ php_fpm_pools | default([]) }}"
  when: php_fpm_pools | length > 0 and ansible_os_family == 'RedHat'

- name: Ensure domain home, tmp and logs directories exist with correct ownership
  ansible.builtin.file:
    path: "{{ item_path }}"
    state: directory
    owner: "{{ item_user }}"
    group: "{{ item_user }}"
    mode: "{{ item_mode }}"
  loop: "{{ php_fpm_pools | default([]) }}"
  loop_control:
    label: "{{ item }}"
  vars:
    item_user: "{{ item | replace('.', '_') }}"
    item_path: "/var/www/{{ item | replace('.', '_') }}"
    item_mode: '0755'
  when: php_fpm_pools | length > 0 and ansible_os_family == 'RedHat'

- name: Ensure domain tmp directory (secure) exists
  ansible.builtin.file:
    path: "/var/www/{{ item | replace('.', '_') }}/tmp"
    state: directory
    owner: "{{ item | replace('.', '_') }}"
    group: "{{ item | replace('.', '_') }}"
    mode: '1770'
  loop: "{{ php_fpm_pools | default([]) }}"
  when: php_fpm_pools | length > 0 and ansible_os_family == 'RedHat'

- name: Ensure domain logs directory exists
  ansible.builtin.file:
    path: "/var/www/{{ item | replace('.', '_') }}/logs"
    state: directory
    owner: "{{ item | replace('.', '_') }}"
    group: "{{ item | replace('.', '_') }}"
    mode: '0755'
  loop: "{{ php_fpm_pools | default([]) }}"
  when: php_fpm_pools | length > 0 and ansible_os_family == 'RedHat'

- name: Deploy per-domain PHP-FPM pool templates
  ansible.builtin.template:
    src: pool.conf.j2
    dest: "/etc/php-fpm.d/{{ item }}.conf"
    owner: root
    group: root
  loop: "{{ php_fpm_pools }}"
  when: php_fpm_pools | length > 0 and ansible_os_family == 'RedHat'
  notify: Restart php-fpm
