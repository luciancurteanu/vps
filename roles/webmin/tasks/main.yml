---
# Webmin installation and configuration

- name: Check if Webmin is already installed
  ansible.builtin.stat:
    path: /etc/webmin/version
  register: webmin_installed

- name: Read existing Webmin version
  ansible.builtin.slurp:
    src: /etc/webmin/version
  register: webmin_version_content
  when: webmin_installed.stat.exists
  changed_when: false

- name: Set fact for installed version
  ansible.builtin.set_fact:
    webmin_current_version: "{{ webmin_version_content.content | b64decode | trim }}"
  when: webmin_installed.stat.exists

- name: Display current Webmin version
  ansible.builtin.debug:
    msg: "Webmin {{ webmin_current_version }} is already installed"
  when: webmin_installed.stat.exists

- name: Add Webmin repository
  ansible.builtin.yum_repository:
    name: Webmin
    description: Webmin Distribution Neutral
    baseurl: "{{ webmin_repo_url }}"
    enabled: true
    gpgcheck: true
    gpgkey: "{{ webmin_gpg_key }}"
  when: ansible_os_family == 'RedHat'

- name: Install Webmin package
  ansible.builtin.dnf:
    name: "webmin{% if webmin_version is defined and webmin_version %}-{{ webmin_version }}{% endif %}"
    state: present
    disable_gpg_check: false
  when: not webmin_installed.stat.exists or (webmin_current_version is defined and webmin_version is defined and webmin_version and webmin_current_version != webmin_version)
  notify: Restart webmin

- name: Create systemd override directory for Webmin
  ansible.builtin.file:
    path: /etc/systemd/system/webmin.service.d
    state: directory
    owner: root
    group: root
    mode: '0755'

- name: Configure Webmin memory limits
  ansible.builtin.copy:
    content: |
      [Service]
      MemoryMax=1G
      MemoryHigh=768M
      Restart=always
      RestartSec=5
    dest: /etc/systemd/system/webmin.service.d/memory-limit.conf
    owner: root
    group: root
    mode: '0644'
  notify: Restart webmin

- name: Reload systemd daemon
  ansible.builtin.systemd:
    daemon_reload: true

- name: Ensure Webmin service is enabled and started
  ansible.builtin.systemd:
    name: webmin
    enabled: true
    state: started

- name: Configure firewall for Webmin
  ansible.builtin.iptables:
    chain: INPUT
    protocol: tcp
    destination_port: "{{ webmin_port }}"
    jump: ACCEPT
    comment: Allow Webmin web interface
  when: firewall_enabled | default(true)
  notify: Save iptables rules

- name: Verify Webmin is accessible
  ansible.builtin.uri:
    url: "{{ 'https' if webmin_ssl_enabled | default(false) else 'http' }}://{{ ansible_host }}:{{ webmin_port }}"
    method: GET
    status_code: [200, 302, 401]
    timeout: 10
    validate_certs: false
  register: webmin_check
  retries: 3
  delay: 5
  until: webmin_check is succeeded
  changed_when: false
  failed_when: false  # TODO: Add proper failure condition

- name: Create Webmin nginx proxy configuration
  ansible.builtin.template:
    src: nginx/webmin.conf.j2
    dest: "/etc/nginx/sites-available/{{ webmin_subdomain }}.conf"
    owner: root
    group: root
    mode: '0644'
  when: webmin_nginx_proxy | default(false)
  notify: Reload nginx

- name: Enable Webmin nginx proxy
  ansible.builtin.file:
    src: "/etc/nginx/sites-available/{{ webmin_subdomain }}.conf"
    dest: "/etc/nginx/sites-enabled/{{ webmin_subdomain }}.conf"
    state: link
  when: webmin_nginx_proxy | default(false)
  notify: Reload nginx

- name: Configure Webmin trusted referers for proxy
  ansible.builtin.lineinfile:
    path: /etc/webmin/config
    regexp: '^referers='
    line: "referers={{ webmin_subdomain }}"
    create: false
  when: webmin_nginx_proxy | default(false)
  notify: Restart webmin

- name: Disable Webmin referers_none check for proxy
  ansible.builtin.lineinfile:
    path: /etc/webmin/config
    regexp: '^referers_none='
    line: 'referers_none=0'
    create: false
  when: webmin_nginx_proxy | default(false)
  notify: Restart webmin

- name: Configure Webmin theme to Authentic Theme with low-resource settings
  ansible.builtin.lineinfile:
    path: /etc/webmin/config
    regexp: '^theme='
    line: "theme={{ webmin_theme }}"
    create: false
  notify: Restart webmin

- name: Ensure Authentic Theme is installed
  ansible.builtin.command: 
    cmd: dnf install -y webmin-authentic-theme
    creates: /usr/share/webmin/authentic-theme
  when: webmin_theme == 'authentic-theme'

- name: Create Authentic Theme config directory
  ansible.builtin.file:
    path: /etc/webmin/authentic-theme
    state: directory
    owner: root
    group: root
    mode: '0755'
  when: webmin_theme == 'authentic-theme'

- name: Configure Authentic Theme low-resource settings
  ansible.builtin.lineinfile:
    path: /etc/webmin/authentic-theme/config
    regexp: '^live_stats='
    line: "live_stats={{ '0' if not webmin_authentic_live_stats else '1' }}"
    create: true
    owner: root
    group: root
    mode: '0644'
  when: webmin_theme == 'authentic-theme'
  notify: Restart webmin

- name: Configure Authentic Theme stats interval
  ansible.builtin.lineinfile:
    path: /etc/webmin/authentic-theme/config
    regexp: '^stats_interval='
    line: "stats_interval={{ webmin_authentic_stats_interval }}"
    create: true
    owner: root
    group: root
    mode: '0644'
  when: webmin_theme == 'authentic-theme'
  notify: Restart webmin

- name: Configure Authentic Theme stats history duration
  ansible.builtin.lineinfile:
    path: /etc/webmin/authentic-theme/config
    regexp: '^stats_history_duration='
    line: "stats_history_duration={{ webmin_authentic_stats_history_duration }}"
    create: true
    owner: root
    group: root
    mode: '0644'
  when: webmin_theme == 'authentic-theme'
  notify: Restart webmin

- name: Configure Authentic Theme monitoring modules
  ansible.builtin.blockinfile:
    path: /etc/webmin/authentic-theme/config
    block: |
      monitor_cpu={{ '1' if webmin_authentic_monitor_cpu else '0' }}
      monitor_memory={{ '1' if webmin_authentic_monitor_memory else '0' }}
      monitor_disk={{ '1' if webmin_authentic_monitor_disk else '0' }}
      monitor_network={{ '1' if webmin_authentic_monitor_network else '0' }}
      monitor_services={{ '1' if webmin_authentic_monitor_services else '0' }}
    create: true
    owner: root
    group: root
    mode: '0644'
  when: webmin_theme == 'authentic-theme'
  notify: Restart webmin
