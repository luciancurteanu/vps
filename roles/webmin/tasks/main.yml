---
# Webmin installation and configuration

- name: Check if Webmin is already installed
  ansible.builtin.stat:
    path: /etc/webmin/version
  register: webmin_installed

- name: Ensure Webmin repository is configured
  ansible.builtin.yum_repository:
    name: Webmin
    description: Webmin Distribution Neutral
    baseurl: "{{ webmin_repo_url }}"
    enabled: true
    gpgcheck: true
    gpgkey: "{{ webmin_gpg_key }}"
  when: ansible_os_family == 'RedHat'

- name: Update DNF cache for Webmin repository
  ansible.builtin.dnf:
    update_cache: true
  when: ansible_os_family == 'RedHat'

- name: Install Webmin package
  ansible.builtin.dnf:
    name: "webmin{{ '-' + webmin_version if webmin_version else '' }}"
    state: present
  notify: Restart webmin

- name: Create systemd override directory for Webmin
  ansible.builtin.file:
    path: /etc/systemd/system/webmin.service.d
    state: directory
    owner: root
    group: root
    mode: '0755'

- name: Configure Webmin memory limits
  ansible.builtin.copy:
    content: |
      [Service]
      MemoryMax=1G
      MemoryHigh=768M
      Restart=always
      RestartSec=5
    dest: /etc/systemd/system/webmin.service.d/memory-limit.conf
    owner: root
    group: root
    mode: '0644'
  notify: Restart webmin

- name: Reload systemd daemon
  ansible.builtin.systemd:
    daemon_reload: true

- name: Ensure Webmin service is enabled and started
  ansible.builtin.systemd:
    name: webmin
    enabled: true
    state: started

- name: Configure firewall for Webmin (iptables)
  ansible.builtin.shell: |
    iptables -C INPUT -p tcp --dport {{ webmin_port }} -j ACCEPT || iptables -A INPUT -p tcp --dport {{ webmin_port }} -j ACCEPT
  args:
    executable: /bin/bash
  when: firewall_enabled | default(true)
  notify: Save iptables rules
  changed_when: false

- name: Create Webmin nginx proxy configuration
  ansible.builtin.template:
    src: nginx/webmin.conf.j2
    dest: "/etc/nginx/sites-available/{{ webmin_subdomain }}.conf"
    owner: root
    group: root
    mode: '0644'
  when: webmin_nginx_proxy | default(false)
  notify: Reload nginx

- name: Enable Webmin nginx proxy
  ansible.builtin.file:
    src: "/etc/nginx/sites-available/{{ webmin_subdomain }}.conf"
    dest: "/etc/nginx/sites-enabled/{{ webmin_subdomain }}.conf"
    state: link
  when: webmin_nginx_proxy | default(false)
  notify: Reload nginx

- name: Ensure Webmin listens on configured port
  ansible.builtin.lineinfile:
    path: /etc/webmin/miniserv.conf
    regexp: '^port='
    line: "port={{ webmin_port }}"
    create: yes
  register: miniserv_port_changed
  when: install_webmin | default(true)
  notify: Restart webmin

- name: Restart webmin if port changed
  ansible.builtin.systemd:
    name: webmin
    state: restarted
  when: miniserv_port_changed is defined and miniserv_port_changed.changed

- name: Wait for Webmin to be available
  ansible.builtin.wait_for:
    port: "{{ webmin_port }}"
    timeout: 60
  when: install_webmin | default(true)

- name: Configure Webmin trusted referers for proxy
  ansible.builtin.lineinfile:
    path: /etc/webmin/config
    regexp: '^referers='
    line: "referers={{ webmin_subdomain }}"
  when: webmin_nginx_proxy | default(false)
  notify: Restart webmin

- name: Disable Webmin referers_none check for proxy
  ansible.builtin.lineinfile:
    path: /etc/webmin/config
    regexp: '^referers_none='
    line: 'referers_none=0'
  when: webmin_nginx_proxy | default(false)
  notify: Restart webmin

- name: Configure Webmin to not redirect when behind proxy
  ansible.builtin.lineinfile:
    path: /etc/webmin/miniserv.conf
    regexp: "^{{ item.key }}="
    line: "{{ item.key }}={{ item.value }}"
  loop:
    - { key: 'webprefix', value: '' }
    - { key: 'webprefixnoredir', value: '1' }
    - { key: 'redirect_ssl', value: '0' }
    - { key: 'redirect_port', value: '0' }
  when: webmin_nginx_proxy | default(false)
  notify: Restart webmin

- name: Configure Webmin theme to Authentic Theme
  ansible.builtin.lineinfile:
    path: /etc/webmin/config
    regexp: '^theme='
    line: "theme={{ webmin_theme }}"
  when: webmin_theme == 'authentic-theme'
  notify: Restart webmin

- name: Ensure Authentic Theme is installed
  when: webmin_theme == 'authentic-theme'
  block:
    - name: Download Authentic Theme release
      ansible.builtin.get_url:
        url: "https://github.com/webmin/authentic-theme/archive/refs/tags/{{ webmin_authentic_version }}.tar.gz"
        dest: "/tmp/authentic-theme-{{ webmin_authentic_version }}.tar.gz"
        mode: '0644'
        timeout: 60

    - name: Extract Authentic Theme
      ansible.builtin.unarchive:
        src: "/tmp/authentic-theme-{{ webmin_authentic_version }}.tar.gz"
        dest: /tmp/
        remote_src: true

    - name: Install Authentic Theme
      ansible.builtin.copy:
        src: "/tmp/authentic-theme-{{ webmin_authentic_version }}/"
        dest: /usr/share/webmin/authentic-theme/
        remote_src: true
        owner: root
        group: root
        mode: '0755'

    - name: Clean up Authentic Theme download
      ansible.builtin.file:
        path: "{{ item }}"
        state: absent
      loop:
        - "/tmp/authentic-theme-{{ webmin_authentic_version }}.tar.gz"
        - "/tmp/authentic-theme-{{ webmin_authentic_version }}"
