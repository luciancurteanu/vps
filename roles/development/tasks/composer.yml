---
# Composer installation tasks

- name: Check if Composer is already installed
  ansible.builtin.stat:
    path: /usr/local/bin/composer
  register: composer_installed

- name: Download Composer setup signature
  ansible.builtin.get_url:
    url: https://composer.github.io/installer.sig
    dest: /tmp/composer-setup.sig
    mode: '0644'
  register: composer_sig
  when: not composer_installed.stat.exists

- name: Download Composer installer
  ansible.builtin.get_url:
    url: https://getcomposer.org/installer
    dest: /tmp/composer-setup.php
    mode: '0755'
  register: composer_download
  when: not composer_installed.stat.exists

- name: Verify Composer installer signature
  ansible.builtin.shell: php -r "if (hash_file('sha384', '/tmp/composer-setup.php') === file_get_contents('/tmp/composer-setup.sig')) { echo 'Installer verified'; } else { echo 'Installer corrupt'; unlink('/tmp/composer-setup.php'); exit(1); }"
  register: composer_verified
  failed_when: "'Installer corrupt' in composer_verified.stdout"
  when: not composer_installed.stat.exists and composer_download is succeeded and composer_sig is succeeded

- name: Install Composer globally (Composer 2.x)
  ansible.builtin.shell: php /tmp/composer-setup.php --install-dir=/usr/local/bin --filename=composer --2
  args:
    creates: /usr/local/bin/composer
  when: not composer_installed.stat.exists and composer_verified is succeeded

- name: Clean up Composer installer files
  ansible.builtin.file:
    path: "{{ item }}"
    state: absent
  with_items:
    - /tmp/composer-setup.php
    - /tmp/composer-setup.sig
  when: not composer_installed.stat.exists and composer_download is succeeded

- name: Add Composer to global PATH
  ansible.builtin.lineinfile:
    path: /etc/profile
    line: 'export PATH="$PATH:/usr/local/bin"'
    state: present

- name: Apply PATH changes
  ansible.builtin.shell: source /etc/profile
  args:
    executable: /bin/bash
  changed_when: false

- name: Check Composer version
  ansible.builtin.command: composer --version
  register: composer_version
  changed_when: false
  failed_when: false

- name: Display Composer version
  ansible.builtin.debug:
    msg: "Installed Composer version: {{ composer_version.stdout }}"
  when: composer_version.rc == 0
