---
# Helper tasks to enable/disable/list existing nginx sites and validate config

- name: Enable existing nginx site
  ansible.builtin.file:
    src: "/etc/nginx/sites-available/{{ site_name }}.conf"
    dest: "/etc/nginx/sites-enabled/{{ site_name }}.conf"
    state: link
    mode: '0644'
    owner: root
    group: root
  when: site_name is defined

- name: Disable nginx site
  ansible.builtin.file:
    path: "/etc/nginx/sites-enabled/{{ site_name }}.conf"
    state: absent
  notify: restart_nginx_service
  when: site_name is defined

- name: List available nginx sites
  ansible.builtin.find:
    paths: /etc/nginx/sites-available
    patterns: "*.conf"
  register: available_sites
  when: nginx_show_sites | default(false)

- name: List enabled nginx sites
  ansible.builtin.find:
    paths: /etc/nginx/sites-enabled
    patterns: "*.conf"
    file_type: link
  register: enabled_sites
  when: nginx_show_sites | default(false)

- name: Display available sites
  ansible.builtin.debug:
    msg: "Available sites: {{ available_sites.files | map(attribute='path') | map('basename') | map('regex_replace', '\\.conf$', '') | list }}"
  when: nginx_show_sites | default(false)

- name: Display enabled sites
  ansible.builtin.debug:
    msg: "Enabled sites: {{ enabled_sites.files | map(attribute='path') | map('basename') | map('regex_replace', '\\.conf$', '') | list }}"
  when: nginx_show_sites | default(false)

- name: Test nginx configuration after site changes
  ansible.builtin.command: nginx -t
  register: nginx_config_test
  changed_when: false
  failed_when: nginx_config_test.rc != 0
  when: site_name is defined
