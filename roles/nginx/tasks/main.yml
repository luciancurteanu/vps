---
# Nginx installation and configuration tasks

- name: Add Nginx repository (RedHat)
  ansible.builtin.template:
    src: nginx/nginx.repo.j2
    dest: /etc/yum.repos.d/nginx.repo
    owner: root
    group: root
    mode: '0644'
  when: ansible_os_family == "RedHat"

- name: Install Nginx (RedHat)
  ansible.builtin.dnf:
    name: nginx
    state: present
  when: ansible_os_family == "RedHat"

- name: Check if nginx.conf backup exists
  ansible.builtin.stat:
    path: /etc/nginx/nginx.conf.bak
  register: nginx_conf_backup

- name: Backup existing nginx.conf
  ansible.builtin.copy:
    src: /etc/nginx/nginx.conf
    dest: /etc/nginx/nginx.conf.bak
    remote_src: yes
    owner: root
    group: root
    mode: '0644'
  when: not nginx_conf_backup.stat.exists
  ignore_errors: yes

- name: Configure Nginx with optimized settings
  ansible.builtin.template:
    src: nginx.conf.j2
    dest: /etc/nginx/nginx.conf
    owner: root
    group: root
    mode: '0644'
  notify: Restart Nginx

- name: Check if default.conf backup exists
  ansible.builtin.stat:
    path: /etc/nginx/conf.d/default.conf.bak
  register: default_conf_backup

- name: Backup existing default.conf
  ansible.builtin.copy:
    src: /etc/nginx/conf.d/default.conf
    dest: /etc/nginx/conf.d/default.conf.bak
    remote_src: yes
    owner: root
    group: root
    mode: '0644'
  when: not default_conf_backup.stat.exists
  ignore_errors: yes

- name: Configure default server for unknown domains
  ansible.builtin.template:
    src: default.conf.j2
    dest: /etc/nginx/conf.d/default.conf
    owner: root
    group: root
    mode: '0644'
  notify: Restart Nginx

- name: Configure system limits for Nginx
  ansible.builtin.lineinfile:
    path: /etc/security/limits.conf
    line: "{{ item }}"
    state: present
  loop:
    - "nginx soft nofile {{ nginx_nofile_limit }}"
    - "nginx hard nofile {{ nginx_nofile_limit }}"

- name: Create Nginx cache directory
  ansible.builtin.file:
    path: "{{ nginx_cache_dir }}"
    state: directory
    owner: nginx
    group: nginx
    mode: '0755'

- name: Create sites-available directory
  ansible.builtin.file:
    path: /etc/nginx/sites-available
    state: directory
    owner: root
    group: root
    mode: '0755'

- name: Create sites-enabled directory
  ansible.builtin.file:
    path: /etc/nginx/sites-enabled
    state: directory
    owner: root
    group: root
    mode: '0755'

- name: Create Nginx runtime directory
  ansible.builtin.file:
    path: /var/run/nginx
    state: directory
    owner: nginx
    group: nginx
    mode: '0755'

- name: Create systemd-tmpfiles configuration for Nginx runtime directory
  ansible.builtin.copy:
    dest: /etc/tmpfiles.d/nginx.conf
    content: |
      # Create /var/run/nginx directory on boot
      d /var/run/nginx 0755 nginx nginx -
    owner: root
    group: root
    mode: '0644'

- name: Set SELinux context for Nginx runtime directory
  community.general.sefcontext:
    target: '/var/run/nginx(/.*)?'
    setype: httpd_var_run_t
    state: present
  when: ansible_selinux.status == "enabled"

- name: Set SELinux context for Nginx PID file  
  community.general.sefcontext:
    target: '/var/run/nginx\.pid'
    setype: httpd_var_run_t
    state: present
  when: ansible_selinux.status == "enabled"

- name: Apply SELinux context to Nginx runtime directory
  ansible.builtin.command: restorecon -Rv /var/run/nginx
  when: ansible_selinux.status == "enabled"
  changed_when: false

- name: Create systemd override directory for Nginx
  ansible.builtin.file:
    path: /etc/systemd/system/nginx.service.d
    state: directory
    mode: '0755'

- name: Override Nginx systemd PIDFile location
  ansible.builtin.copy:
    content: |
      [Service]
      PIDFile=/run/nginx.pid
    dest: /etc/systemd/system/nginx.service.d/override.conf
    mode: '0644'
  notify: Restart Nginx

- name: Reload systemd daemon
  ansible.builtin.systemd:
    daemon_reload: yes
    
- name: Test Nginx configuration
  ansible.builtin.command: nginx -t
  register: nginx_config_test
  changed_when: false
  check_mode: no
  notify: Restart Nginx
  ignore_errors: "{{ ansible_check_mode | default(false) }}"

- name: Apply SELinux context to Nginx PID file location
  ansible.builtin.command: restorecon -v /var/run/nginx.pid
  when: ansible_selinux.status == "enabled"
  failed_when: false
  changed_when: false
    
- name: Enable Nginx service
  ansible.builtin.systemd:
    name: nginx
    enabled: true
    state: started

- name: Configure SELinux for Nginx
  ansible.posix.seboolean:
    name: httpd_enable_homedirs
    state: true
    persistent: true
  when: ansible_selinux.status is defined and ansible_selinux.status == "enabled"

- name: Allow Nginx to connect to network services (for proxying)
  ansible.posix.seboolean:
    name: httpd_can_network_connect
    state: true
    persistent: true
  when: ansible_selinux.status is defined and ansible_selinux.status == "enabled"