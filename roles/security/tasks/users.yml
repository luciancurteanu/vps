---
# User management tasks

- name: Create admin group
  ansible.builtin.group:
    name: "{{ admin_group }}"
    state: present

- name: Create admin user
  ansible.builtin.user:
    name: "{{ admin_user }}"
    group: "{{ admin_group }}"
    createhome: true
    # Password set conditionally below based on admin_auth
    password: "{{ vault_admin_password | password_hash('sha512') if admin_auth == 'password' and vault_admin_password is defined else omit }}"
    update_password: on_create

- name: "Validate SSH key presence if admin_auth is 'key'"
  ansible.builtin.assert:
    that:
      - admin_ssh_public_key | default('', true) | length > 0
    fail_msg: "admin_auth is set to 'key' but admin_ssh_public_key (sourced from vault_admin_ssh_public_key) is not defined in secrets.yml. Please provide the key or set admin_auth to 'password'."
    quiet: true
  when: admin_auth == 'key'

- name: Set up authorized keys for admin user
  ansible.posix.authorized_key: # Explicitly using FQCN
    user: "{{ admin_user }}"
    state: present
  when: admin_ssh_public_key | default('', true) | length > 0 and admin_auth == 'key'

- name: Add admin user to sudoers
  ansible.builtin.template:
    src: sudoers/admin.j2 # Path relative to security role's templates
    dest: "/etc/sudoers.d/{{ admin_user }}"
    owner: root
    group: root
    validate: "/usr/sbin/visudo -cf %s"
