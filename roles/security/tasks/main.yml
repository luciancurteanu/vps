---
# Security role: Main tasks

- name: Include OS-specific variables
  ansible.builtin.include_vars: "{{ ansible_os_family | lower }}.yml"
  when: ansible_os_family == 'RedHat'

# Ensure firewalld is not present
- name: Ensure firewalld is not installed
  ansible.builtin.package:
    name: Firewalld
    state: absent
  when: ansible_os_family == 'RedHat' and security_firewall_service == "iptables"
  changed_when: not (ansible_virtualization_type | default('') == 'docker')

# Firewall configuration
- name: Configure firewall
  ansible.builtin.include_tasks: firewall.yml
  when: security_firewall_enabled | default(true)
  tags: ['firewall', 'security']

# Fail2ban configuration
- name: Install fail2ban
  ansible.builtin.package:
    name:
      - fail2ban
      - whois
    state: present
  when: security_fail2ban_enabled | default(true)
  changed_when: not (ansible_virtualization_type | default('') == 'docker')
  tags: ['fail2ban', 'security']

- name: Copy fail2ban local config
  ansible.builtin.copy:
    src: /etc/fail2ban/fail2ban.conf
    dest: /etc/fail2ban/fail2ban.local
    remote_src: true
    force: false
  when: security_fail2ban_enabled | default(true)
  tags: ['fail2ban', 'security']

- name: Configure iptables action to use DROP instead of REJECT
  ansible.builtin.lineinfile:
    path: /etc/fail2ban/action.d/iptables.conf
    regexp: '^blocktype.*'
    line: 'blocktype = DROP'
  when: security_fail2ban_enabled | default(true)
  tags: ['fail2ban', 'security']

- name: Configure sendmail-lc action for fail2ban
  ansible.builtin.template:
    src: fail2ban/sendmail-lc.conf.j2
    dest: /etc/fail2ban/action.d/sendmail-lc.conf
    owner: root
    group: root
    mode: '0644'
  when: security_fail2ban_enabled | default(true)
  tags: ['fail2ban', 'security']

# Check which service log files exist to enable appropriate jails
- name: Check if SSH log exists
  ansible.builtin.stat:
    path: /var/log/secure
  register: stat_secure_log
  when: security_fail2ban_enabled | default(true)
  tags: ['fail2ban', 'security']

- name: Check if mail log exists
  ansible.builtin.stat:
    path: /var/log/maillog
  register: stat_maillog
  when: security_fail2ban_enabled | default(true)
  tags: ['fail2ban', 'security']

- name: Check if MariaDB log exists
  ansible.builtin.stat:
    path: /var/log/mariadb/error.log
  register: stat_mariadb_log
  when: security_fail2ban_enabled | default(true)
  tags: ['fail2ban', 'security']

- name: Check if nginx access logs exist
  ansible.builtin.find:
    paths: /home
    patterns: 'access.log'
    recurse: true
    file_type: file
  register: find_access_logs
  when: security_fail2ban_enabled | default(true)
  tags: ['fail2ban', 'security']

- name: Set fact for nginx access logs existence
  ansible.builtin.set_fact:
    have_access_logs: "{{ find_access_logs.matched > 0 }}"
  when: security_fail2ban_enabled | default(true)
  tags: ['fail2ban', 'security']

- name: Configure fail2ban jail
  ansible.builtin.template:
    src: fail2ban/jail.local.j2
    dest: /etc/fail2ban/jail.local
    owner: root
    group: root
    mode: '0644'
  when: security_fail2ban_enabled | default(true)
  notify: restart fail2ban
  tags: ['fail2ban', 'security']

- name: Add fail2ban filters for all services
  ansible.builtin.template:
    src: "fail2ban/{{ item }}.conf.j2"
    dest: "/etc/fail2ban/filter.d/{{ item }}.conf"
    owner: root
    group: root
    mode: '0644'
  with_items:
    - postfix
    - dovecot
    - mariadb
    - badbot
    - badurl
  when: security_fail2ban_enabled | default(true)
  notify: restart fail2ban
  tags: ['fail2ban', 'security']

- name: Ensure fail2ban service is enabled and running
  ansible.builtin.service:
    name: Fail2ban
    state: started
    enabled: true
  when: security_fail2ban_enabled | default(true)
  changed_when: not (ansible_virtualization_type | default('') == 'docker')
  tags: ['fail2ban', 'security']

- name: Apply fail2ban configuration changes immediately
  ansible.builtin.meta: flush_handlers
  when: security_fail2ban_enabled | default(true)
  tags: ['fail2ban', 'security']

- name: Wait for fail2ban socket
  ansible.builtin.wait_for:
    path: /var/run/fail2ban/fail2ban.sock
    state: present
    timeout: "{{ security_fail2ban_socket_timeout }}"
  when:
    - security_fail2ban_enabled | default(true)
    - security_firewall_initialize | default(true)
    - ansible_virtualization_type | default('') != 'docker'
  tags: ['fail2ban', 'security']

# Special task to initialize fail2ban chains (needed first time)
- name: Initialize fail2ban chains with test bans
  ansible.builtin.shell: |
    # Initialize all enabled jails
    {% if stat_secure_log.stat.exists %}
    fail2ban-client set sshd banip 1.1.1.1 || true
    fail2ban-client reload --unban sshd || true
    {% endif %}
    {% if stat_maillog.stat.exists %}
    fail2ban-client set postfix banip 1.1.1.1 || true
    fail2ban-client reload --unban postfix || true
    fail2ban-client set dovecot banip 1.1.1.1 || true
    fail2ban-client reload --unban dovecot || true
    {% endif %}
    {% if stat_mariadb_log.stat.exists %}
    fail2ban-client set mariadb banip 1.1.1.1 || true
    fail2ban-client reload --unban mariadb || true
    {% endif %}
    {% if have_access_logs %}
    fail2ban-client set badbot banip 1.1.1.1 || true
    fail2ban-client reload --unban badbot || true
    fail2ban-client set badurl banip 1.1.1.1 || true
    fail2ban-client reload --unban badurl || true
    {% endif %}

    # Save iptables state (skip in containers)
    {% if not (ansible_virtualization_type | default('') == 'docker') %}
    systemctl is-active iptables && iptables-save > /etc/sysconfig/iptables || true
    {% endif %}
  args:
    executable: /bin/bash
  when:
    - security_fail2ban_enabled | default(true)
    - security_firewall_initialize | default(true)
    - ansible_virtualization_type | default('') != 'docker'
  changed_when: false  # This task is for initialization only
  ignore_errors: true  # Fail2ban commands may fail in test environments
  tags: ['fail2ban', 'security']
