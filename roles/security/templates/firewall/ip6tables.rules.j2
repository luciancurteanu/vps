# {{ ansible_managed }}
# IPv6 Iptables rules for {{ inventory_hostname }}
*filter
:INPUT DROP [0:0]
:FORWARD DROP [0:0]
:OUTPUT ACCEPT [0:0]

# Allow loopback traffic
-A INPUT -i lo -j ACCEPT

# Allow established and related connections
-A INPUT -m state --state ESTABLISHED,RELATED -j ACCEPT

# Allow ICMPv6 (important for IPv6 functionality)
-A INPUT -p ipv6-icmp -j ACCEPT

# Allow SSH
-A INPUT -p tcp --dport {{ security_ssh_port | default(22) }} -j ACCEPT

# Allow defined services
{% for service in security_firewall_allowed_services %}
-A INPUT -p {{ service.proto | default('tcp') }} --dport {{ service.port }} -j ACCEPT
{% endfor %}

# Mail service ports (when this is the master domain)
{% if domain | default('') == (master_domain | default('')) %}
{% for service in security_mail_service_ports %}
-A INPUT -p {{ service.proto | default('tcp') }} --dport {{ service.port }} -j ACCEPT
{% endfor %}
{% endif %}

# Log and drop all other traffic
-A INPUT -j LOG --log-prefix "IP6TABLES DROP: " --log-level 4
-A INPUT -j DROP

COMMIT