---
# MariaDB installation and configuration tasks

- name: Install MariaDB server and client packages from AppStream
  ansible.builtin.dnf:
    name:
      - mariadb-server
      - mariadb
      - python3-PyMySQL
    state: present
  when: ansible_os_family == "RedHat"

- name: Create MariaDB log directory
  ansible.builtin.file:
    path: /var/log/mariadb
    state: directory
    owner: mysql
    group: mysql

- name: Create MariaDB configuration directory
  ansible.builtin.file:
    path: /etc/mysql/conf.d
    state: directory
    owner: root
    group: root

- name: Backup MariaDB server.cnf
  ansible.builtin.copy:
    src: /etc/my.cnf.d/server.cnf
    mode: '0644'
    dest: /etc/my.cnf.d/server.cnf.bak
    remote_src: true
    force: false
  failed_when: false  # TODO: Add proper failure condition

- name: Configure MariaDB server
  ansible.builtin.template:
    src: server.cnf.j2
    dest: /etc/my.cnf.d/server.cnf
    owner: root
    group: root
  notify: restart mariadb

- name: Backup MariaDB client.cnf
  ansible.builtin.copy:
    src: /etc/my.cnf.d/client.cnf
    mode: '0644'
    dest: /etc/my.cnf.d/client.cnf.bak
    remote_src: true
    force: false
  failed_when: false  # TODO: Add proper failure condition

- name: Configure MariaDB client
  ansible.builtin.template:
    src: client.cnf.j2
    dest: /etc/my.cnf.d/client.cnf
    owner: root
    group: root

- name: Enable and start MariaDB
  ansible.builtin.systemd:
    name: mariadb
    state: started
    enabled: true

- name: Check if MariaDB is already secured
  ansible.builtin.stat:
    path: /var/lib/mysql/.mysql_setup_complete
    get_checksum: false
  register: mysql_setup_stat
 
- name: Ensure MySQL root password is set (module)
  ansible.builtin.shell: |
    mysql --protocol=socket --socket=/var/lib/mysql/mysql.sock -e "ALTER USER 'root'@'localhost' IDENTIFIED BY '{{ db_root_password }}'; FLUSH PRIVILEGES;"
  when: not mysql_setup_stat.stat.exists and db_root_password is defined and (db_root_password | length) > 0
  register: set_root_password
  failed_when: set_root_password.rc != 0 and 'Access denied' not in set_root_password.stderr

- name: Create root credentials file (when password set)
  ansible.builtin.template:
    src: root.my.cnf.j2
    dest: /root/.my.cnf
    owner: root
    group: root
  when: not mysql_setup_stat.stat.exists and db_root_password is defined and (db_root_password | length) > 0

- name: Ensure root uses password auth plugin
  community.mysql.mysql_user:
    name: root
    host: localhost
    password: "{{ db_root_password }}"
    plugin: mysql_native_password
    check_implicit_admin: yes
    login_unix_socket: /var/lib/mysql/mysql.sock
  when: not mysql_setup_stat.stat.exists and db_root_password is defined and (db_root_password | length) > 0
  failed_when: false

- name: Secure MariaDB installation (module-based)
  block:
    - name: Try remove anonymous users via socket
      community.mysql.mysql_query:
        login_unix_socket: /var/lib/mysql/mysql.sock
        query: "DELETE FROM mysql.user WHERE User=''; FLUSH PRIVILEGES;"
      register: remove_anonymous_socket
      failed_when: false

    - name: Remove anonymous users (password auth fallback)
      community.mysql.mysql_query:
        login_user: root
        login_password: "{{ db_root_password }}"
        query: "DELETE FROM mysql.user WHERE User=''; FLUSH PRIVILEGES;"
      when: (remove_anonymous_socket is defined and (remove_anonymous_socket.failed | default(false))) and db_root_password is defined and (db_root_password | length) > 0

    - name: Try remove test database via socket
      community.mysql.mysql_query:
        login_unix_socket: /var/lib/mysql/mysql.sock
        query: "DROP DATABASE IF EXISTS Test;"
      register: remove_test_socket
      failed_when: false

    - name: Remove test database (password auth fallback)
      community.mysql.mysql_query:
        login_user: root
        login_password: "{{ db_root_password }}"
        query: "DROP DATABASE IF EXISTS Test;"
      when: (remove_test_socket is defined and (remove_test_socket.failed | default(false))) and db_root_password is defined and (db_root_password | length) > 0

    - name: Try disallow root login remotely via socket
      community.mysql.mysql_query:
        login_unix_socket: /var/lib/mysql/mysql.sock
        query: "DELETE FROM mysql.user WHERE User='root' AND Host NOT IN ('localhost','127.0.0.1'); FLUSH PRIVILEGES;"
      register: disallow_remote_socket
      failed_when: false

    - name: Disallow root login remotely (password auth fallback)
      community.mysql.mysql_query:
        login_user: root
        login_password: "{{ db_root_password }}"
        query: "DELETE FROM mysql.user WHERE User='root' AND Host NOT IN ('localhost','127.0.0.1'); FLUSH PRIVILEGES;"
      when: (disallow_remote_socket is defined and (disallow_remote_socket.failed | default(false))) and db_root_password is defined and (db_root_password | length) > 0

    - name: Try flush privileges via socket
      community.mysql.mysql_query:
        login_unix_socket: /var/lib/mysql/mysql.sock
        query: "FLUSH PRIVILEGES;"
      register: flush_socket
      failed_when: false

    - name: Flush privileges (password auth fallback)
      community.mysql.mysql_query:
        login_user: root
        login_password: "{{ db_root_password }}"
        query: "FLUSH PRIVILEGES;"
      when: (flush_socket is defined and (flush_socket.failed | default(false))) and db_root_password is defined and (db_root_password | length) > 0

    - name: Create setup complete flag file
      ansible.builtin.file:
        path: /var/lib/mysql/.mysql_setup_complete
        state: touch
        owner: mysql
        group: mysql
  when: not mysql_setup_stat.stat.exists

# Create specific database users matching the bash script implementation
- name: Create standard database users (password auth)
  community.mysql.mysql_user:
    login_user: root
    login_password: "{{ db_root_password }}"
    name: "{{ item.name }}"
    password: "{{ item.password }}"
    host: "{{ item.host }}"
    priv: "{{ item.priv }}"
    state: present
  loop:
    - { name: "{{ db_remote_user | default('remote_user') }}", password: "{{ db_remote_password | default(db_root_password) }}", host: '%', priv: '*.*:ALL' }
    - { name: 'webclient', password: "{{ db_webclient_password | default(db_root_password) }}", host: 'localhost', priv: '*.*:ALL' }
  when: db_root_password is defined and (db_root_password | length) > 0
  register: create_users_result
  failed_when: false

- name: Create standard database users (socket auth fallback)
  community.mysql.mysql_user:
    login_unix_socket: /var/lib/mysql/mysql.sock
    name: "{{ item.name }}"
    password: "{{ item.password }}"
    host: "{{ item.host }}"
    priv: "{{ item.priv }}"
    state: present
  loop:
    - { name: "{{ db_remote_user | default('remote_user') }}", password: "{{ db_remote_password | default(db_root_password) }}", host: '%', priv: '*.*:ALL' }
    - { name: 'webclient', password: "{{ db_webclient_password | default(db_root_password) }}", host: 'localhost', priv: '*.*:ALL' }
  when: db_root_password is not defined or (db_root_password | length) == 0 or (create_users_result is defined and (create_users_result.failed | default(false)))
    

- name: Create database backup directory
  ansible.builtin.file:
    path: "{{ db_backup_dir }}"
    state: directory
    owner: root
    group: root

- name: Setup automatic database backups
  ansible.builtin.cron:
    name: "Database backup"
    hour: "3"
    minute: "0"
    job: "mysqldump --user=root --password={{ db_root_password }} --all-databases | gzip > {{ db_backup_dir }}/mysql-all-`date +\\%Y\\%m\\%d`.sql.gz"
    user: root
  when: setup_db_backups | default(true)

- name: Configure tune-db settings
  ansible.builtin.include_tasks: performance.yml
  when: db_optimize_for_server | default(true)
